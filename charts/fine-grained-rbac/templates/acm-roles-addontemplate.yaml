apiVersion: addon.open-cluster-management.io/v1alpha1
kind: AddOnTemplate
metadata:
  name: acm-roles
  labels:
    velero.io/exclude-from-backup: 'true'
spec:
  addonName: acm-roles
  agentSpec:
    workload:
      manifests:
        # =============================================================================
        # MANAGED CLUSTER ROLES (where VMs run)
        # =============================================================================

        # -----------------------------------------------------------------------------
        # acm-virt:view - Read-only VM access (no secrets, no migration)
        # Binding: RoleBinding (namespace-scoped)
        # -----------------------------------------------------------------------------
        - apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRole
          metadata:
            labels:
              rbac.open-cluster-management.io/filter: vm-clusterroles
              clusterview.open-cluster-management.io/discoverable: "true"
            name: acm-virt:view
          rules:
            - apiGroups:
              - k8s.cni.cncf.io
              resources:
              - network-attachment-definitions
              verbs:
              - get
              - list
            - apiGroups:
              - ""
              resources:
              - configmaps
              - events
              - namespaces
              - nodes
              - persistentvolumeclaims
              - persistentvolumes
              - pods
              - pods/metrics
              - pods/log
              - services
              - serviceaccounts
              verbs:
              - get
              - list
              - watch
            - apiGroups:
              - events.k8s.io
              resources:
              - events
              verbs:
              - get
              - list
              - watch
            - apiGroups:
              - cdi.kubevirt.io
              resources:
              - datavolumes
              - datasources
              - dataimportcrons
              verbs:
              - get
              - list
              - watch
            - apiGroups:
              - metrics.k8s.io
              resources:
              - pods
              verbs:
              - get
              - list
              - watch
            - apiGroups:
              - hco.kubevirt.io
              resources:
              - hyperconvergeds
              verbs:
              - get
              - list
              - watch
            - apiGroups:
              - monitoring.coreos.com
              resources:
              - prometheuses/api
              resourceNames:
              - k8s
              verbs:
              - get
              - watch
            - apiGroups:
              - batch
              resources:
              - jobs
              verbs:
              - get
              - list
              - watch
            - apiGroups:
              - snapshot.storage.k8s.io
              resources:
              - "*"
              verbs:
              - get
              - list
              - watch
            - apiGroups:
              - project.openshift.io
              resources:
              - projects
              verbs:
              - get
              - list
              - watch
            - apiGroups:
              - template.openshift.io
              resources:
              - templates
              verbs:
              - get
              - list
              - watch

        # -----------------------------------------------------------------------------
        # acm-virt:admin - Full VM management + secrets (no migration)
        # Binding: RoleBinding (namespace-scoped)
        # Fixes: ACM-27287 (secrets missing get verb)
        # -----------------------------------------------------------------------------
        - apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRole
          metadata:
            labels:
              rbac.open-cluster-management.io/filter: vm-clusterroles
              clusterview.open-cluster-management.io/discoverable: "true"
            name: acm-virt:admin
          rules:
            - apiGroups:
              - k8s.cni.cncf.io
              resources:
              - network-attachment-definitions
              verbs:
              - get
              - list
            - apiGroups:
              - ""
              resources:
              - secrets
              verbs:
              - get
              - list
              - watch
              - create
              - update
              - patch
              - delete
            - apiGroups:
              - ""
              resources:
              - configmaps
              - events
              - namespaces
              - nodes
              - nodes/proxy
              - nodes/exec
              - persistentvolumeclaims
              - persistentvolumes
              - pods
              - pods/exec
              - pods/log
              - pods/metrics
              - services
              - serviceaccounts
              verbs:
              - get
              - list
              - watch
              - create
              - update
              - patch
              - delete
            - apiGroups:
              - events.k8s.io
              resources:
              - events
              verbs:
              - get
              - list
              - watch
            - apiGroups:
              - cdi.kubevirt.io
              resources:
              - datavolumes
              - datasources
              - dataimportcrons
              verbs:
              - get
              - list
              - watch
              - create
              - update
              - patch
              - delete
            - apiGroups:
              - metrics.k8s.io
              resources:
              - pods
              verbs:
              - get
              - list
              - watch
            - apiGroups:
              - monitoring.coreos.com
              resources:
              - prometheuses/api
              resourceNames:
              - k8s
              verbs:
              - get
              - watch
            - apiGroups:
              - hco.kubevirt.io
              resources:
              - hyperconvergeds
              verbs:
              - get
              - list
              - watch
              - create
              - update
              - patch
              - delete
            - apiGroups:
              - batch
              resources:
              - jobs
              verbs:
              - get
              - list
              - watch
              - create
              - update
              - patch
              - delete
            - apiGroups:
              - snapshot.storage.k8s.io
              resources:
              - "*"
              verbs:
              - get
              - list
              - watch
              - create
              - update
              - patch
              - delete
            - apiGroups:
              - project.openshift.io
              resources:
              - projects
              verbs:
              - get
              - list
              - watch
              - create
              - update
              - patch
              - delete
            - apiGroups:
              - template.openshift.io
              resources:
              - templates
              verbs:
              - get
              - list
              - watch
              - create
              - update
              - patch
              - delete

        # -----------------------------------------------------------------------------
        # acm-virt:migrate - Migration policies + version checks (managed cluster)
        # Binding: ClusterRoleBinding (cluster-scoped resources)
        # Addresses: ACM-26074 (clusterversions for compatibility check)
        # -----------------------------------------------------------------------------
        - apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRole
          metadata:
            labels:
              rbac.open-cluster-management.io/filter: vm-clusterroles
              clusterview.open-cluster-management.io/discoverable: "true"
            name: acm-virt:migrate
          rules:
            - apiGroups:
              - migrations.kubevirt.io
              resources:
              - migrationpolicies
              verbs:
              - get
              - list
              - watch
              - create
              - update
              - patch
              - delete
            - apiGroups:
              - config.openshift.io
              resources:
              - clusterversions
              verbs:
              - get
              - list
              - watch
            - apiGroups:
              - operators.coreos.com
              resources:
              - clusterserviceversions
              verbs:
              - get
              - list
              - watch

        # =============================================================================
        # HUB CLUSTER ROLES (ACM control plane)
        # =============================================================================

        # -----------------------------------------------------------------------------
        # acm-fleet:view - Fleet Virtualization UI (managedclusters, kubevirtprojects)
        # Binding: ClusterRoleBinding (cluster-scoped on Hub)
        # Adds: userpermissions (ACM-26480)
        # -----------------------------------------------------------------------------
        - apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRole
          metadata:
            labels:
              rbac.open-cluster-management.io/filter: vm-clusterroles
              clusterview.open-cluster-management.io/discoverable: "true"
            name: acm-fleet:view
          rules:
            - apiGroups:
              - clusterview.open-cluster-management.io
              resources:
              - managedclusters
              verbs:
              - list
              - get
              - watch
            - apiGroups:
              - cluster.open-cluster-management.io
              resources:
              - managedclusters
              verbs:
              - get
              - list
              - watch
            - apiGroups:
              - clusterview.open-cluster-management.io
              resources:
              - kubevirtprojects
              verbs:
              - list
            - apiGroups:
              - clusterview.open-cluster-management.io
              resources:
              - userpermissions
              verbs:
              - list

        # -----------------------------------------------------------------------------
        # acm-migration:view - View Forklift migrations (Hub - read-only)
        # Binding: ClusterRoleBinding (cluster-scoped on Hub)
        # -----------------------------------------------------------------------------
        - apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRole
          metadata:
            labels:
              rbac.open-cluster-management.io/filter: vm-clusterroles
              clusterview.open-cluster-management.io/discoverable: "true"
            name: acm-migration:view
          rules:
            - apiGroups:
              - forklift.konveyor.io
              resources:
              - migrations
              - providers
              - plans
              - networkmaps
              - storagemaps
              verbs:
              - get
              - list
              - watch

        # -----------------------------------------------------------------------------
        # acm-migration:admin - Manage Forklift migrations (Hub - full access)
        # Binding: ClusterRoleBinding (cluster-scoped on Hub)
        # -----------------------------------------------------------------------------
        - apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRole
          metadata:
            labels:
              rbac.open-cluster-management.io/filter: vm-clusterroles
              clusterview.open-cluster-management.io/discoverable: "true"
            name: acm-migration:admin
          rules:
            - apiGroups:
              - forklift.konveyor.io
              resources:
              - migrations
              - providers
              - plans
              - networkmaps
              - storagemaps
              verbs:
              - get
              - list
              - watch
              - create
              - update
              - patch
              - delete